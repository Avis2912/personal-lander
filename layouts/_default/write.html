{{ define "main" }}
<div class="write-container" id="auth-container">
  <div class="auth-box">
    <input type="password" id="password" placeholder="Enter password" class="password-input">
    <button onclick="authenticate()" class="submit-btn">Enter</button>
  </div>
</div>

<div class="write-container hidden" id="editor-container">
  <div class="editor-box">
    <input type="text" id="title" placeholder="Article title" class="title-input">
    <textarea id="content" placeholder="Write your article in Markdown..." class="content-input"></textarea>
    <div class="controls">
      <button onclick="previewMarkdown()" class="preview-btn">Preview</button>
      <button onclick="saveToGitHub()" class="save-btn">Save & Publish</button>
    </div>
  </div>
</div>

<style>
.write-container {
  max-width: var(--main-width);
  margin: 2rem auto;
  padding: 0 1rem;
}

.hidden {
  display: none;
}

.auth-box {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-top: 4rem;
}

.password-input {
  font-family: var(--font-mono);
  padding: 0.5rem;
  border: 1px solid var(--content-secondary);
  border-radius: 4px;
  background: var(--background);
  color: var(--content-primary);
}

.submit-btn, .preview-btn, .download-btn, .save-btn {
  font-family: var(--font-mono);
  padding: 0.5rem 1rem;
  border: 1px solid var(--content-secondary);
  border-radius: 4px;
  background: var(--background);
  color: var(--content-primary);
  cursor: pointer;
}

.submit-btn:hover, .preview-btn:hover, .download-btn:hover, .save-btn:hover {
  background: var(--content-secondary);
  color: var(--background);
}

.editor-box {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.title-input {
  font-family: var(--font-body);
  font-size: 1.5rem;
  padding: 0.5rem;
  border: 1px solid var(--content-secondary);
  border-radius: 4px;
  background: var(--background);
  color: var(--content-primary);
}

.content-input {
  font-family: var(--font-mono);
  min-height: 500px;
  padding: 1rem;
  border: 1px solid var(--content-secondary);
  border-radius: 4px;
  background: var(--background);
  color: var(--content-primary);
  resize: vertical;
}

.controls {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
}

.save-btn {
  font-family: var(--font-mono);
  padding: 0.5rem 1rem;
  border: 1px solid var(--content-secondary);
  border-radius: 4px;
  background: var(--accent);
  color: var(--background);
  cursor: pointer;
}

.save-btn:hover {
  opacity: 0.9;
}
</style>

<script src="/assets/js/github-config.js"></script>
<script>
function authenticate() {
  const password = document.getElementById('password').value;
  if (password === 'popop09090') {
    document.getElementById('auth-container').classList.add('hidden');
    document.getElementById('editor-container').classList.remove('hidden');
  } else {
    alert('Incorrect password');
  }
}

function previewMarkdown() {
  const title = document.getElementById('title').value;
  const content = document.getElementById('content').value;
  const win = window.open('', '_blank');
  win.document.write(`
    <html>
      <head>
        <title>Preview: ${title}</title>
        <link rel="stylesheet" href="/assets/combined.min.css">
      </head>
      <body class="auto">
        <div class="content">
          <h1>${title}</h1>
          <div class="single-content">
            ${content}
          </div>
        </div>
      </body>
    </html>
  `);
}

async function saveToGitHub() {
  const title = document.getElementById('title').value;
  const content = document.getElementById('content').value;
  const date = new Date().toISOString().split('T')[0];
  
  const markdown = `---
title: "${title}"
date: ${date}
draft: false
---

${content}`;

  const filename = `content/writings/${title.toLowerCase().replace(/\s+/g, '-')}.md`;
  const encodedContent = btoa(unescape(encodeURIComponent(markdown)));

  try {
    // Create the new file directly without checking for previous commits
    const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filename}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: `Add new article: ${title}`,
        content: encodedContent,
        branch: 'main'
      })
    });

    const data = await response.json();

    if (response.ok) {
      alert('Article saved and published successfully!');
      document.getElementById('title').value = '';
      document.getElementById('content').value = '';
    } else {
      throw new Error(data.message || 'Failed to save file');
    }
  } catch (error) {
    alert('Error saving article: ' + error.message);
    console.error('Error:', error);
  }
}
</script>
{{ end }}